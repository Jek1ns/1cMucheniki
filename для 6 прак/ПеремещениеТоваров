Процедура ОбработкаПроведения(Отказ, Режим)
	Движения.ПартииТоваров.Записывать = Истина;
	Движения.ПартииТоваров.Очистить();
	
	// Собираем номенклатуру для оптимизации запросов
	СписокНоменклатуры = Новый СписокЗначений;
	Для Каждого ТекСтрока Из ТоварыИУслуги Цикл
		СписокНоменклатуры.Добавить(ТекСтрока.Номенклатура);
	КонецЦикла;
	
	// Получаем все остатки по нужной номенклатуре и складу
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ПартииТоваровОстатки.Номенклатура КАК Номенклатура,
	|	ПартииТоваровОстатки.Партия КАК Партия,
	|	ПартииТоваровОстатки.КоличествоОстаток КАК Количество,
	|	ПартииТоваровОстатки.СуммаОстаток КАК Сумма
	|ИЗ
	|	РегистрНакопления.ПартииТоваров.Остатки(
	|		&МоментВремени,
	|		Номенклатура В (&СписокНоменклатуры)
	|		И Склад = &СкладОтправитель
	|	) КАК ПартииТоваровОстатки
	|УПОРЯДОЧИТЬ ПО
	|	Номенклатура,
	|	Партия.Дата"; // FIFO по дате партии
	
	Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
	Запрос.УстановитьПараметр("СкладОтправитель", СкладОтправитель);
	Запрос.УстановитьПараметр("СписокНоменклатуры", СписокНоменклатуры);
	
	// Группируем остатки по номенклатуре
	ОстаткиПоНоменклатуре = Новый Соответствие;
	Результат = Запрос.Выполнить().Выбрать();
	Пока Результат.Следующий() Цикл
		Ключ = Результат.Номенклатура;
		Если Не ОстаткиПоНоменклатуре.Содержит(Ключ) Тогда
			ОстаткиПоНоменклатуре.Вставить(Ключ, Новый Массив);
		КонецЕсли;
		
		ДанныеПартии = Новый Структура;
		ДанныеПартии.Вставить("Партия", Результат.Партия);
		ДанныеПартии.Вставить("Количество", Результат.Количество);
		ДанныеПартии.Вставить("Сумма", Результат.Сумма);
		
		ОстаткиПоНоменклатуре[Ключ].Добавить(ДанныеПартии);
	КонецЦикла;
	
	// Обрабатываем каждую строку документа
	Для Каждого ТекСтрока Из ТоварыИУслуги Цикл
		
		Номенклатура = ТекСтрока.Номенклатура;
		ОстатокДляСписания = ТекСтрока.Количество;
		
		// Проверяем наличие остатков по номенклатуре
		Если Не ОстаткиПоНоменклатуре.Содержит(Номенклатура) Тогда
			Отказ = Истина;
			Сообщить("Товар " + Номенклатура + " не найден на складе-отправителе!");
			Возврат;
		КонецЕсли;
		
		МассивПартий = ОстаткиПоНоменклатуре[Номенклатура];
		ОбщаяСуммаСписания = 0;
		
		// Списываем по FIFO из доступных партий
		Для Каждого Партия Из МассивПартий Цикл
			
			Если ОстатокДляСписания <= 0 Тогда
				Прервать;
			КонецЕсли;
			
			ДоступноеКоличество = Партия.Количество;
			Если ДоступноеКоличество <= 0 Тогда
				Продолжить;
			КонецЕсли;
			
			КоличествоДляСписания = Мин(ОстатокДляСписания, ДоступноеКоличество);
			
			// Расчет суммы списания
			Если ДоступноеКоличество > 0 Тогда
				СтоимостьЕдиницы = Партия.Сумма / ДоступноеКоличество;
				СуммаСписания = СтоимостьЕдиницы * КоличествоДляСписания;
			Иначе
				СуммаСписания = 0;
			КонецЕсли;
			
			// Расход со склада-отправителя
			ДвижениеРасход = Движения.ПартииТоваров.Добавить();
			ДвижениеРасход.ВидДвижения = ВидДвиженияНакопления.Расход;
			ДвижениеРасход.Период = Дата;
			ДвижениеРасход.Склад = СкладОтправитель;
			ДвижениеРасход.Номенклатура = Номенклатура;
			ДвижениеРасход.Партия = Партия.Партия;
			ДвижениеРасход.Количество = КоличествоДляСписания;
			ДвижениеРасход.Сумма = СуммаСписания;
			
			// Приход на склад-получатель (сохраняем ту же партию)
			ДвижениеПриход = Движения.ПартииТоваров.Добавить();
			ДвижениеПриход.ВидДвижения = ВидДвиженияНакопления.Приход;
			ДвижениеПриход.Период = Дата;
			ДвижениеПриход.Склад = СкладПолучатель;
			ДвижениеПриход.Номенклатура = Номенклатура;
			ДвижениеПриход.Партия = Партия.Партия;
			ДвижениеПриход.Количество = КоличествоДляСписания;
			ДвижениеПриход.Сумма = СуммаСписания;
			
			ОбщаяСуммаСписания = ОбщаяСуммаСписания + СуммаСписания;
			ОстатокДляСписания = ОстатокДляСписания - КоличествоДляСписания;
			
		КонецЦикла;
		
		// Проверяем, что хватило остатков
		Если ОстатокДляСписания > 0 Тогда
			Отказ = Истина;
			Сообщить("Недостаточно товара " + Номенклатура + " на складе! Не хватает: " + ОстатокДляСписания);
			Возврат;
		КонецЕсли;
		
	КонецЦикла;
КонецПроцедуры
